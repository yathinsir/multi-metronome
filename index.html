<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>同步節拍器</title>
  <script src="https://-cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tone@14.8.39/build/Tone.min.js"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family: sans-serif; }
    body { background:#111; color:#fff; text-align:center; padding:20px; }
    h1 { margin-bottom:20px; font-size:1.8rem; }
    input, button, select { margin:5px; padding:12px; font-size:1rem; border-radius:8px; border:none; }
    input, select { background:#333; color:#fff; width:80px; }
    button { background:#00d4aa; color:#000; cursor:pointer; font-weight:bold; }
    button:active { transform:scale(0.95); }
    #room { margin:20px 0; }
    #room input { width:200px; font-family:monospace; letter-spacing:2px; }
    #metronome { margin:30px 0; }
    .beat { display:inline-block; width:60px; height:60px; margin:0 10px; background:#333; border-radius:50%; line-height:60px; font-size:1.5rem; transition:0.1s; }
    .beat.active { background:#00d4aa; transform:scale(1.2); box-shadow:0 0 20px #00d4aa; }
    #status { margin-top:20px; color:#aaa; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <h1>同步節拍器</h1>

  <div id="setup">
    <div id="room">
      <input type="text" id="roomCode" placeholder="輸入房間碼" maxlength="6" />
      <button id="joinBtn">加入房間</button>
      <button id="createBtn">建立房間</button>
    </div>
  </div>

  <div id="metronome" class="hidden">
    <div>
      <button id="startBtn">開始</button>
      <button id="stopBtn">停止</button>
    </div>
    <div style="margin:20px 0;">
      <label>BPM: <input type="number" id="bpm" value="120" min="40" max="240" /></label>
      <label>拍子:
        <select id="timeSig">
          <option value="4">4/4</option>
          <option value="3">3/4</option>
          <option value="6">6/8</option>
        </select>
      </label>
    </div>

    <div id="beats"></div>
    <div id="status"></div>
  </div>

  <script>
    const socket = io();
    let isHost = false;
    let roomCode = '';
    let intervalId = null;
    let currentBeat = 0;
    let synth = null;

    // DOM
    const setupDiv = document.getElementById('setup');
    const metronomeDiv = document.getElementById('metronome');
    const joinBtn = document.getElementById('joinBtn');
    const createBtn = document.getElementById('createBtn');
    const roomInput = document.getElementById('roomCode');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const bpmInput = document.getElementById('bpm');
    const timeSigSelect = document.getElementById('timeSig');
    const beatsDiv = document.getElementById('beats');
    const statusDiv = document.getElementById('status');

    // 建立房間
    createBtn.onclick = () => {
      roomCode = Math.random().toString(36).substring(2, 8).toUpperCase();
      roomInput.value = roomCode;
      joinRoom();
    };

    // 加入房間
    joinBtn.onclick = () => {
      roomCode = roomInput.value.trim().toUpperCase();
      if (roomCode.length !== 6) return alert('房間碼必須是6碼');
      joinRoom();
    };

    function joinRoom() {
      socket.emit('join-room', roomCode);
      setupDiv.classList.add('hidden');
      metronomeDiv.classList.remove('hidden');
      statusDiv.textContent = `房間：${roomCode} | 等待其他人...`;
    }

    // 接收房間狀態
    socket.on('room-joined', (data) => {
      isHost = data.isHost;
      updateBPM(data.bpm);
      timeSigSelect.value = data.beatsPerBar;
      renderBeats(data.beatsPerBar);
      statusDiv.textContent = `已加入房間：${roomCode} ${isHost ? '(你是指揮)' : ''}`;
      initTone();
    });

    socket.on('update-state', (state) => {
      updateBPM(state.bpm);
      timeSigSelect.value = state.beatsPerBar;
      renderBeats(state.beatsPerBar);
      if (state.isRunning) {
        startMetronome(state.bpm, state.beatsPerBar, state.currentBeat);
      } else {
        stopMetronome();
      }
    });

    socket.on('beat', (beatIndex) => {
      highlightBeat(beatIndex);
      playSound(beatIndex === 0);
    });

    socket.on('user-count', (count) => {
      statusDiv.textContent = `房間：${roomCode} | ${count} 人線上 ${isHost ? '(你是指揮)' : ''}`;
    });

    // 初始化 Tone.js
    function initTone() {
      if (synth) return;
      synth = new Tone.Synth({
        oscillator: { type: 'sine' },
        envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.1 }
      }).toDestination();
    }

    function playSound(isDownbeat) {
      if (!synth) return;
      const freq = isDownbeat ? 880 : 440;
      const vol = isDownbeat ? -6 : -12;
      synth.triggerAttackRelease(freq, '16n', undefined, Tone.gainToDb(vol / 20));
    }

    // 渲染節拍圓圈
    function renderBeats(beats) {
      beatsDiv.innerHTML = '';
      for (let i = 0; i < beats; i++) {
        const div = document.createElement('div');
        div.className = 'beat';
        div.textContent = i + 1;
        div.id = `beat-${i}`;
        beatsDiv.appendChild(div);
      }
    }

    function highlightBeat(index) {
      document.querySelectorAll('.beat').forEach((b, i) => {
        b.classList.toggle('active', i === index);
      });
    }

    // 開始節拍器
    startBtn.onclick = () => {
      if (!isHost) return alert('只有指揮可以開始！');
      const bpm = parseInt(bpmInput.value);
      const beats = parseInt(timeSigSelect.value);
      socket.emit('start-metronome', { bpm, beatsPerBar: beats });
    };

    stopBtn.onclick = () => {
      if (!isHost) return alert('只有指揮可以停止！');
      socket.emit('stop-metronome');
    };

    bpmInput.onchange = () => {
      if (!isHost) return;
      const bpm = Math.max(40, Math.min(240, parseInt(bpmInput.value) || 120));
      bpmInput.value = bpm;
      socket.emit('update-bpm', bpm);
    };

    timeSigSelect.onchange = () => {
      if (!isHost) return;
      const beats = parseInt(timeSigSelect.value);
      socket.emit('update-timeSig', beats);
    };

    function updateBPM(bpm) {
      bpmInput.value = bpm;
    }

    function startMetronome(bpm, beatsPerBar, startBeat = 0) {
      stopMetronome();
      currentBeat = startBeat;
      const interval = 60000 / bpm;
      intervalId = setInterval(() => {
        highlightBeat(currentBeat);
        playSound(currentBeat === 0);
        currentBeat = (currentBeat + 1) % beatsPerBar;
      }, interval);
    }

    function stopMetronome() {
      if (intervalId) clearInterval(intervalId);
      intervalId = null;
      document.querySelectorAll('.beat').forEach(b => b.classList.remove('active'));
    }

    // 離開前停止
    window.addEventListener('beforeunload', () => {
      socket.emit('leave-room', roomCode);
    });
  </script>
</body>
</html>